# Register Surplus Forms – Product Requirements Document  

> All stories below **must** render markup identical to the artefact (wording, ordering, spacing) by using the GOV.UK Design System Nunjucks macros.

## Data model (API contract)

| Field | Type | Notes |
| --- | --- | --- |
| `id` | `uuid` | Returned by API |
| `referenceNumber` | `char(8)` | e.g. **HDJ2123F** |
| `formType` | `string` | enum: AD01, B07, K432, D243, OTHER |
| `formTypeOtherText` | `string?` | required when `formType` = "OTHER", must not be empty |
| `penColourNotUsed` | `string` | enum: BLUE, BLACK, RED, GREEN |
| `guidanceRead` | `string` | enum: YES, LOOKED_AT_NOW, NO |
| `createdAt` | `datetime` | generated by API |

---

## Technology Architecture

### Session Management
The application must use express-session for maintaining user state between steps with the following configuration:
- Session data must persist all form answers between steps
- Session should be destroyed after the confirmation page is viewed
- Each page should validate that previous steps have been completed before allowing access
- Use `req.session.registration` for storing form data

### API Integration
- API is available at `http://localhost:8000/api/v1`  
- All requests must use node-fetch with appropriate error handling
- Validation should occur both client-side and via API responses
- Responses must be properly parsed and validated before use

### Error Handling
- Validation errors should be stored in `req.session.errors` for form validation
- API errors should be stored in `req.session.apiErrors` for display
- Show specific error messages for validation failures
- In non-production environments, include detailed error information for debugging

### Navigation Flow
- Each step must validate that previous steps have been completed before allowing access
- If a user attempts to access a step without completing prerequisites, redirect to the appropriate starting point
- Implement the following validation pattern for each route:
  ```javascript
  // Example for Pen Colour page
  if (!req.session.registration || !req.session.registration.formType) {
    return res.redirect('/form-type');
  }
  ```
- When a user revisits a previous step, preserve all their existing answers
- After form submission and confirmation, clear the session data to prevent duplicate submissions

---

## Feature 1 – Start / index page (`/`)

### 1.1 Render start page **(frontend)**  
**As a** user  
**I want** a start page identical to the first screen in the artefact  
**so that** I understand what the service does and can begin.

*Design / UX*  
- Implement content and components exactly as per screen labelled "Start page" in the artifeact
- **Page title:** "Register surplus forms"

*Acceptance*  
```
Given I visit /
Then the title, bullet list and green Start button match the artefact
When I press Start now
Then I am redirected to /form-type
```

*Architecture notes*  
- **Files**  
  - `routes/index.js` – GET handler.  This already exists and needs to be updated
  - `views/pages/home.njk` – template.  This already exists and needs to be updated
- Controller initialises `req.session.registration = {}`.

---

## Feature 2 – Form type page (`/form-type`)

### 2.1 Capture form type **(frontend)**  
**As a** user  
**I want** to choose the form I am registering using the radio list displayed in the artefact  
**so that** my choice is stored in the session.

*Design / UX*  
- Implement content and components exactly as per screen labelled "Question, radios, conditional reveal: Form type page" in the artifeact
- **Page title:** "Which form are you applying for?"
- `govukRadios` with items **AD01, B07, K432, D243, Other (conditional reveal)**.  
- Conditional reveal is a `govukInput` labelled "Enter form code (for example 'LL05')".  

*Acceptance*  
```
Given I pick "AD01" and press Save and continue
Then session.registration = { formType:"AD01" }
 And I advance to /pen-colour-not-used

Given I pick "Other" and leave the textbox empty
When I press Save and continue
Then I remain on the page
 And an error summary appears with msg "Enter a form code"
```

*Architecture notes*  
- **Files**  
  - `routes/form-type.js` – GET / POST.  
  - `views/pages/form-type.njk`.  
- Use validator util `validateRadioWithOther` with parameters:
  - `radioValue`: Selected form type
  - `otherValue`: Optional form code text
  - `otherOptionValue`: "OTHER" - value indicating the "Other" option is selected
  - `radioFieldName`: "formType" - name of the radio field for error messages
  - `otherFieldName`: "form code" - name of the "Other" text field for error messages
- When storing data, ensure formTypeOtherText is only included when formType is "OTHER"

### 2.2 Prefill answer on revisit **(frontend)**  
Same copy as 2.1; on GET, controller passes saved values to template.

---

## Feature 3 – Pen colour not used page (`/pen-colour-not-used`)

### 3.1 Capture pen colour **(frontend)**  
**As a** user  
**I want** to answer "What colour pen did you use to not fill in the form?" exactly as shown  
**so that** the colour is saved.

*Design / UX*  
- Implement content and components exactly as per screen labelled "Question, radios, hint text: Pen colour not used page" in the artifeact
- **Page title:** "What colour pen did you use to not fill in the form?"
 
*Acceptance*  
```
Given I select "Blue"
Then registration.penColourNotUsed:"BLUE"
```

*Architecture & file paths* identical pattern to Feature 2.  
Files: `routes/pen-colour-not-used.js`, `views/pages/pen-colour-not-used.njk`.

---

## Feature 4 – 147-page guidance page (`/guidance-read`)

### 4.1 Capture guidance read **(frontend)**  
**As a** user  
**I want** to answer "Did you read the 147-page guidance?"  
**so that** my response is stored.

*Design / UX*  
- Implement content and components exactly as per screen labelled "Question, radios: 147 page guidance" in the artifeact
- **Page title:** "Did you read the 147-page guidence?"

*Acceptance*  
```
Given I choose "Yes"
Then registration.guidanceRead:"YES"
```

*Architecture*  
Files: `routes/guidance-read.js`, `views/pages/guidance-read.njk`.

---

## Feature 5 – Check your answers page (`/check-your-answers`)

### 5.1 Display summary **(frontend)**  
**As a** user  
**I want** a review page identical to the artefact  
**so that** I can verify answers before submission.

*Design / UX*  
- Implement content and components exactly as per screen labelled "Check your answers page" in the artifeact
- **Page title:** "Check your answers before submitting your form?"

*Acceptance*  
```
Given my answers are in session
When I arrive at /check-your-answers
Then the summary list shows my values to match the artefact
 And each Change link navigates back

Given I press Confirm and submit
Then the frontend posts the JSON body to POST /api/v1/registrations
```

*Architecture*  
The POST /api/v1/registrations will use the data built up from the previous screens. The data model and API is specified in the API Documentation. 

### 5.2 Submit to API & handle errors **(frontend)**  
**As a** user  
**I want** to reach confirmation if the API call succeeds, and see helpful errors otherwise  
**so that** I know the outcome.

*Acceptance*  
```
Given the API returns 201
Then I am redirected to /confirmation
 And id & referenceNumber are in session

Given the API returns 422
Then I remain on /check-your-answers
 And a red error banner reads "There's a problem – check your answers and try again."

Given the API returns 503+
Then I see the GOV.UK 503 service unavailable template
```

*Architecture notes*  
- `routes/check-your-answers.js` POST handler
- API payload must match the data model exactly:
  ```json
  {
    "formType": "AD01", // or other valid form type 
    "formTypeOtherText": "Custom type", // only include when formType is "OTHER"
    "penColourNotUsed": "BLUE", // valid pen colour
    "guidanceRead": "YES" // valid guidance read response
  }
  ```
- Validate data structure before submission using a custom validation utility
- API will respond with: 
  - 201 → Success with `id` and `referenceNumber`
  - 422 → Validation error with specific error details
  - 503 → Service unavailable
- For successful responses (201): 
  - Store `session.referenceNumber` and `session.id`
  - Delete `session.registration`  
  - Redirect to `/confirmation`
- For validation errors (422): 
  - Store errors in `req.session.apiErrors`
  - Display the specific error message from the API
  - Re-render page with error banner
- For service errors (503+): 
  - Forward to error handler with `next(err)`

---

## Feature 6 – Confirmation page (`/confirmation`)

### 6.1 Render confirmation **(frontend)**  
**As a** user  
**I want** the confirmation screen in the artefact (green success panel)  
**so that** I have my reference number.

*Design / UX*  
- Implement content and components exactly as per screen labelled "Confirmation page" in the artifeact
- **Page title:** "Registration complete"

*Acceptance*  
```
Given referenceNumber exists in session
When I visit /confirmation
Then the reference is displayed in the green panel
 And session is destroyed afterwards

Given referenceNumber is missing
Then I am redirected to /
```

*Architecture notes*  
- **Files**  
  - `routes/confirmation.js`, `views/pages/confirmation.njk`.
- Session must be destroyed after displaying the confirmation page
- Redirect to home page if accessed directly without a valid referenceNumber