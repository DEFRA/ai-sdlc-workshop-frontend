# Register Surplus Forms Technical Design

## Frontend

### Session Management
The application must use express-session for maintaining user state between steps with the following configuration:
- Session data must persist all form answers between steps
- Session should be destroyed after the confirmation page is viewed
- Each page should validate that previous steps have been completed before allowing access
- Use `req.session.registration` for storing form data

### Routing
- The application uses Express Router for all route management
- The route structure follows this URL hierarchy:
  - `/` - Start page (renders the index page)
  - `/form-type` - Form type selection page (renders the form-details page)
  - `/pen-colour` - Pen colour selection page (renders the digital-product page)
  - `/form-guidance` - Guidance question page (renders the form-guidance page)
  - `/check-answers` - Review and submit page (renders the check-answers page)
  - `/confirmation` - Confirmation page with reference number (renders the confirmation page)
- Form submissions should redirect to appropriate routes based on user journey and validation:
  - On successful submission: redirect to next step
  - On validation error: redirect back to the same page with error information
  - On missing session data: redirect to start page
- Back links should direct to the previous step in the journey
- Note that in Express, the first matching route handler will process the request, so ensure the existing index route won't intercept requests intended for the new register surplus forms service

### API Integration
- API is available at `http://localhost:8000/api/v1`  
- All requests must use node-fetch with appropriate error handling
- Validation should occur both client-side and via API responses
- Responses must be properly parsed and validated before use

### Error Handling
- Validation errors should be stored in `req.session.errors` for form validation
- API errors should be stored in `req.session.apiErrors` for display
- Show specific error messages for validation failures
- Include detailed error information for debugging

---

## Data Model (API Contract)

| Field               | Type                                   | Notes                                                                                  |
| ------------------- | -------------------------------------- | -------------------------------------------------------------------------------------- |
| `id`                | `uuid` **PK**                          | `uuidv4` created by API, returned to frontend                                          |
| `referenceNumber`   | `char(8)`                              | Format `/^[A-Z0-9]{8}$/`, e.g. **HDJ2123F** â€“ generated by API for confirmation screen |
| `formType`          | `string`                               | enum: `AD01`, `B07`, `K432`, `D243`, `OTHER`                                           |
| `formTypeOtherText` | `string nullable`                      | only sent when `formType === "OTHER"`                                                  |
| `penColourNotUsed`  | `string`                               | enum: `BLUE`, `BLACK`, `RED`, `GREEN`                                                  |
| `guidanceRead`      | `string`                               | enum: `YES`, `LOOKED_AT_NOW`, `NO`                                                     |
| `createdAt`         | `datetime` default `CURRENT_TIMESTAMP` | audit only                                                                             | 

---

## Backend APIs

### POST /api/v1/registrations

#### Description
Stores a completed registration form and returns ID and reference number

#### Endpoint
```
POST /api/v1/registrations
```

#### Headers
```
Content-Type: application/json
```

#### Body Schema
```json
{
  "type": "object",
  "required": [
    "formType",
    "penColourNotUsed",
    "guidanceRead"
  ],
  "properties": {
    "formType": {
      "type": "string",
      "enum": ["AD01", "B07", "K432", "D243", "OTHER"]
    },
    "formTypeOtherText": {
      "type": "string"
    },
    "penColourNotUsed": {
      "type": "string",
      "enum": ["BLUE", "BLACK", "RED", "GREEN", "OTHER"]
    },
    "guidanceRead": {
      "type": "string",
      "enum": ["YES", "LOOKED_AT_NOW", "NO"]
    }
  },
  "additionalProperties": false
}
```

#### Example Request
```json
{
  "formType": "AD01",
  "penColourNotUsed": "BLUE",
  "guidanceRead": "YES"
}
```

#### Example Request with OTHER form type
```json
{
  "formType": "OTHER",
  "formTypeOtherText": "Custom form type",
  "penColourNotUsed": "RED",
  "guidanceRead": "LOOKED_AT_NOW"
}
```

#### Responses

##### 201 Created
Successfully created registration

```json
{
  "id": "2b3c55b8-a480-4f2e-bf0d-8d3f9e2bf4be",
  "referenceNumber": "HDJ2123F"
}
```

##### 422 Unprocessable Entity
Validation error

```json
{
  "status": "error",
  "message": "Validation failed",
  "errors": [
    {
      "field": "formType",
      "message": "must be equal to one of the allowed values"
    }
  ]
}
```

##### 503 Service Unavailable
Server or database error

```json
{
  "status": "error",
  "message": "Service unavailable"
}
```

#### Validation Rules
- `formType` must be one of: "AD01", "B07", "K432", "D243", "OTHER"
- If `formType` is "OTHER", then `formTypeOtherText` is required and must not be empty
- `penColourNotUsed` must be one of: "BLUE", "BLACK", "RED", "GREEN", "OTHER"
- `guidanceRead` must be one of: "YES", "LOOKED_AT_NOW", "NO"
- No additional properties are allowed

### GET /api/v1/registrations/:id

#### Description
Retrieves a specific registration by its UUID

#### Endpoint
```
GET /api/v1/registrations/:id
```

#### Parameters
- `id` (path parameter): UUID of the registration to retrieve

#### Example
```
GET /api/v1/registrations/2b3c55b8-a480-4f2e-bf0d-8d3f9e2bf4be
```

#### Responses

##### 200 OK
Successfully retrieved registration

```json
{
  "id": "2b3c55b8-a480-4f2e-bf0d-8d3f9e2bf4be",
  "referenceNumber": "HDJ2123F",
  "formType": "AD01",
  "formTypeOtherText": null,
  "penColourNotUsed": "BLUE",
  "guidanceRead": "YES"
}
```

##### 404 Not Found
Registration not found

```json
{
  "status": "error",
  "message": "Not Found"
}
```

##### 503 Service Unavailable
Server or database error

```json
{
  "status": "error",
  "message": "Service unavailable"
}
```
